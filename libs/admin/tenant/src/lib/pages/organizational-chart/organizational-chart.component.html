<main *transloco="let t" class="main-page">
  <header>
    <h1>{{ t('organizationalChart') }}</h1>
    <button (click)="upsertUnit(dialog)" tuiButton>{{ t('addOrganizationalUnit') }}</button>
  </header>
  <section #scrollbar class="main-section">
    <div class="flex justify-end gap-1">
      <span class="font-semibold"> {{ (zoom$ | async | number: '1.0-0') + '%' }}</span>
      <hero-icon class="w-6 h-6" name="zoom-in" type="solid"></hero-icon>
    </div>
    <tui-scrollbar
      (mouseenter)="canZoom = true"
      (mouseleave)="canZoom = false"
      *ngIf="chart$ | async as chart"
      class="w-0 min-w-full"
    >
      <div
        *ngIf="dimension$ | async as dim"
        [style]="{
          width: dim.wrap,
          '--unit': dim.unit,
          '--image': dim.image,
          '--icon': dim.icon,
          '--one': dim.one,
          '--three-quarter': dim['three-quarter'],
          '--half': dim.half,
          '--quarter': dim.quarter,
          '--bar': dim.bar
        }"
        class="min-w-full my-4"
      >
        <ng-template *ngTemplateOutlet="content; context: { $implicit: chart }"></ng-template>
        <ng-template #content let-unit>
          <ng-container *tuiLet="unit.descendants?.length as length">
            <div
              (mouseenter)="hovering = unit"
              (mouseleave)="hovering = null"
              [class.ring]="hovering === unit"
              class="unit flex relative border mx-auto"
            >
              <img
                class="image object-contain"
                src="https://pbs.twimg.com/profile_images/1369877387949699074/tcvNQSr1.jpg"
              />
              <div>
                <p class="name font-semibold">{{ unit.orgName }}</p>
                <p class="sub-name text-gray-500">{{ unit.code }}</p>
              </div>
              <div *ngIf="hovering === unit" class="icons flex absolute">
                <hero-icon (click)="upsertUnit(content, unit)" name="pencil-alt" type="solid"></hero-icon>
                <hero-icon (click)="deleteUnit(unit.id)" *ngIf="!length" name="trash" type="solid"></hero-icon>
              </div>
            </div>
            <ng-container *ngIf="length > 1">
              <div class="bar-vertical bg-black mx-auto"></div>
              <div
                [style]="{ height: dim.bar, width: ((length - 1) / length) * 100 + '%' }"
                class="bg-black mx-auto"
              ></div>
            </ng-container>
            <div *ngIf="length" [class]="'grid-cols-' + length" class="grid">
              <div *ngFor="let i of [].constructor(length)" class="bar-vertical bg-black justify-self-center"></div>
              <div *ngFor="let child of unit.descendants">
                <ng-template *ngTemplateOutlet="content; context: { $implicit: child }"></ng-template>
              </div>
            </div>
          </ng-container>
        </ng-template>
      </div>
    </tui-scrollbar>
  </section>

  <ng-template #dialog let-observer>
    <form (ngSubmit)="submitUnit(observer)" [formGroup]="$any(form)">
      <formly-form [fields]="fields" [form]="$any(form)" [model]="model" class="formly-gap"></formly-form>
      <div class="flex justify-center gap-6 mt-8">
        <button (click)="observer.complete()" appearance="outline" tuiButton type="button">{{ t('cancel') }}</button>
        <button tuiButton>{{ t('save') }}</button>
      </div>
    </form>
  </ng-template>
</main>
