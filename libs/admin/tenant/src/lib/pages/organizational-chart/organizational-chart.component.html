<main *transloco="let t" class="main-page">
  <header>
    <h1>{{ t('organizationalChart') }}</h1>
    <button (click)="upsertUnit(dialog)" tuiButton>{{ t('addOrganizationalUnit') }}</button>
  </header>
  <section #scrollbar class="main-section">
    <div class="flex justify-end gap-1">
      <span class="font-semibold"> {{ (zoom$ | async | number: '1.0-0') + '%' }}</span>
      <hero-icon class="w-6 h-6" name="zoom-in" type="solid"></hero-icon>
    </div>
    <tui-scrollbar
      (mouseenter)="canZoom = true"
      (mouseleave)="canZoom = false"
      *ngIf="chart$ | async as chart"
      class="w-0 min-w-full"
    >
      <div
        *ngIf="dimension$ | async as dim"
        [style]="{
          width: dim.wrap,
          '--unit': dim.unit,
          '--image': dim.image,
          '--icon': dim.icon,
          '--one': dim.one,
          '--three-quarter': dim['three-quarter'],
          '--half': dim.half,
          '--quarter': dim.quarter,
          '--bar': dim.bar
        }"
        class="min-w-full my-4"
      >
        <ng-template *ngTemplateOutlet="content; context: { $implicit: chart, span: getSpan(chart) }"></ng-template>
        <ng-template #content let-span="span" let-unit>
          <ng-container *tuiLet="unit.descendants?.length as children">
            <div
              (mouseenter)="hovering = unit"
              (mouseleave)="hovering = null"
              [class.ring]="hovering === unit"
              class="unit flex relative border mx-auto"
            >
              <tui-avatar [autoColor]="true" size="l" [rounded]="true" [text]="unit.orgName"></tui-avatar>
              <div class="info flex flex-col">
                <p class="name font-semibold">{{ unit.orgName }}</p>
                <p class="sub-name text-gray-500">{{ unit.orgType }}</p>
                <p class="sub-name text-gray-500">{{ unit.code }}</p>
              </div>
              <!--              <div *ngIf="hovering === unit" class="icons flex absolute">-->
              <!--                <hero-icon (click)="upsertUnit(content, unit)" name="pencil-alt" type="solid"></hero-icon>-->
              <!--                <hero-icon (click)="deleteUnit(unit.id)" *ngIf="!children" name="trash" type="solid"></hero-icon>-->
              <!--              </div>-->
            </div>
            <div *ngIf="children > 1" class="vertical-bar bg-black mx-auto"></div>
            <div *ngIf="children" class="flex">
              <div
                *ngFor="let child of unit.descendants; first as first; last as last"
                [style.width]="(getSpan(child) / span) * 100 + '%'"
              >
                <div class="grid grid-cols-2">
                  <div [class.bg-black]="!first" class="horizontal-bar"></div>
                  <div [class.bg-black]="!last" class="horizontal-bar"></div>
                </div>
                <div class="vertical-bar bg-black mx-auto"></div>
                <ng-template
                  *ngTemplateOutlet="content; context: { $implicit: child, span: getSpan(child) }"
                ></ng-template>
              </div>
            </div>
          </ng-container>
        </ng-template>
      </div>
    </tui-scrollbar>
  </section>

  <ng-template #dialog let-observer>
    <form (ngSubmit)="submitUnit(observer)" [formGroup]="$any(form)">
      <formly-form [fields]="fields" [form]="$any(form)" [model]="model" class="formly-gap"></formly-form>
      <div class="flex justify-center gap-6 mt-8">
        <button (click)="observer.complete()" appearance="outline" tuiButton type="button">{{ t('cancel') }}</button>
        <button tuiButton>{{ t('save') }}</button>
      </div>
    </form>
  </ng-template>
</main>
